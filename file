{"AWSTemplateFormatVersion":"2010-09-09","Resources":{"GatefoldAPIGateway":{"Type":"AWS::ApiGateway::RestApi","Properties":{"Body":{"swagger":"2.0","info":{"version":"2018-04-19T14:20:40Z","title":"Gatefold"},"host":"sowinski.blue","schemes":["https"],"paths":{"/":{"post":{"consumes":["application/json"],"produces":["application/json"],"responses":{"200":{"description":"200 response","schema":{"$ref":"#/definitions/Empty"},"headers":{"Access-Control-Allow-Origin":{"type":"string"}}}},"security":[{"auth0":[]}],"x-amazon-apigateway-integration":{"credentials":{"Fn::GetAtt":["GatefoldAPIRole","Arn"]},"uri":"arn:aws:apigateway:eu-west-1:dynamodb:action/PutItem","responses":{"default":{"statusCode":"200","responseParameters":{"method.response.header.Access-Control-Allow-Origin":"'*'"},"responseTemplates":{"application/json":"#set ($rand = $context.requestId.substring(28))\n\n{\n    \"shortUrl\": \"https://sowinski.blue/$rand\"\n}"}}},"passthroughBehavior":"never","httpMethod":"POST","requestTemplates":{"application/json":"#set ($rand = $context.requestId.substring(28))\n{\n    \"TableName\": \"gatefold\",\n    \"Item\": {\n        \"ShortUrl\": {\n            \"S\": \"$rand\"\n        },\n        \"LongUrl\": {\n            \"S\": $input.json('$.longUrl')\n        }\n    }\n}\n"},"type":"aws"}},"options":{"consumes":["application/json"],"produces":["application/json"],"responses":{"200":{"description":"200 response","schema":{"$ref":"#/definitions/Empty"},"headers":{"Access-Control-Allow-Origin":{"type":"string"},"Access-Control-Allow-Methods":{"type":"string"},"Access-Control-Allow-Headers":{"type":"string"}}}},"x-amazon-apigateway-integration":{"responses":{"default":{"statusCode":"200","responseParameters":{"method.response.header.Access-Control-Allow-Methods":"'POST,OPTIONS'","method.response.header.Access-Control-Allow-Headers":"'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'","method.response.header.Access-Control-Allow-Origin":"'*'"}}},"passthroughBehavior":"when_no_match","requestTemplates":{"application/json":"{\"statusCode\": 200}"},"type":"mock"}}},"/livecheck":{"get":{"consumes":["application/json"],"produces":["application/json"],"responses":{"200":{"description":"200 response","schema":{"$ref":"#/definitions/Empty"}}},"x-amazon-apigateway-integration":{"responses":{"default":{"statusCode":"200"}},"passthroughBehavior":"when_no_match","requestTemplates":{"application/json":"{\"statusCode\": 200}"},"type":"mock"}}},"/not-found":{"get":{"consumes":["application/json"],"responses":{"404":{"description":"404 response"}},"x-amazon-apigateway-integration":{"responses":{"default":{"statusCode":"404"}},"passthroughBehavior":"when_no_match","requestTemplates":{"application/json":"{\"statusCode\": 404}"},"type":"mock"}},"options":{"consumes":["application/json"],"produces":["application/json"],"responses":{"200":{"description":"200 response","schema":{"$ref":"#/definitions/Empty"},"headers":{"Access-Control-Allow-Origin":{"type":"string"},"Access-Control-Allow-Methods":{"type":"string"},"Access-Control-Allow-Headers":{"type":"string"}}}},"x-amazon-apigateway-integration":{"responses":{"default":{"statusCode":"200","responseParameters":{"method.response.header.Access-Control-Allow-Methods":"'DELETE,GET,HEAD,OPTIONS,PATCH,POST,PUT'","method.response.header.Access-Control-Allow-Headers":"'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'","method.response.header.Access-Control-Allow-Origin":"'*'"}}},"passthroughBehavior":"when_no_match","requestTemplates":{"application/json":"{\"statusCode\": 200}"},"type":"mock"}}},"/{id}":{"get":{"produces":["application/json"],"parameters":[{"name":"id","in":"path","required":true,"type":"string"}],"responses":{"302":{"description":"302 response","headers":{"Location":{"type":"string"}}}},"x-amazon-apigateway-integration":{"uri":"https://sowinski.blue/{id}/proxied","responses":{"default":{"statusCode":"302","responseParameters":{"method.response.header.Location":"integration.response.body.longUrl"},"responseTemplates":{"application/json":"#set($inputRoot = $input.path('$'))\n{ }"}}},"requestParameters":{"integration.request.path.id":"method.request.path.id"},"passthroughBehavior":"when_no_match","httpMethod":"GET","type":"http"}}},"/{id}/proxied":{"get":{"consumes":["application/json"],"produces":["application/json"],"parameters":[{"name":"id","in":"path","required":true,"type":"string"}],"responses":{"200":{"description":"200 response"}},"x-amazon-apigateway-integration":{"credentials":{"Fn::GetAtt":["GatefoldAPIRole","Arn"]},"uri":"arn:aws:apigateway:eu-west-1:dynamodb:action/GetItem","responses":{"default":{"statusCode":"200","responseTemplates":{"application/json":"#set($inputRoot = $input.path('$'))\n#if($inputRoot.Item.LongUrl.S.isEmpty())\n#set($val = \"https://sowinski.blue/not-found\")\n#else\n  #set($val = $inputRoot.Item.LongUrl.S)\n#end\n\n{\n  \"longUrl\": \"$val\"\n}"}}},"passthroughBehavior":"never","httpMethod":"POST","requestTemplates":{"application/json":"{\n    \"TableName\": \"gatefold\",\n    \"Key\": {\n        \"ShortUrl\": {\n            \"S\": \"$input.params(\"id\")\"\n        }\n    }\n}"},"type":"aws"}},"options":{"produces":["application/json"],"responses":{"200":{"description":"200 response","schema":{"$ref":"#/definitions/Empty"},"headers":{"Access-Control-Allow-Origin":{"type":"string"},"Access-Control-Allow-Methods":{"type":"string"},"Access-Control-Allow-Headers":{"type":"string"}}}},"x-amazon-apigateway-integration":{"credentials":{"Fn::GetAtt":["GatefoldAPIRole","Arn"]},"uri":"arn:aws:apigateway:eu-west-1:dynamodb:action/GetItem","responses":{"default":{"statusCode":"200"}},"passthroughBehavior":"never","httpMethod":"POST","type":"aws"}}}},"securityDefinitions":{"auth0":{"type":"apiKey","name":"Authorization","in":"header","x-amazon-apigateway-authtype":"custom","x-amazon-apigateway-authorizer":{"authorizerUri":"arn:aws:apigateway:eu-west-1:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-1:601343171996:function:Auth0Authorizer:GenericV2Only/invocations","authorizerResultTtlInSeconds":60,"type":"token"}}},"definitions":{"Empty":{"type":"object","title":"Empty Schema"}}},"Description":"The most compact URL shortener. Developed at Cimpress.","Name":"Gatefold"}},"GatefoldDDBTable":{"Type":"AWS::DynamoDB::Table","Properties":{"KeySchema":[{"AttributeName":"ShortUrl","KeyType":"HASH"}],"ProvisionedThroughput":{"ReadCapacityUnits":1,"WriteCapacityUnits":1},"TableName":"gatefold"}},"GatefoldAPIDDBRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":["apigateway.amazonaws.com"]},"Action":"sts:AssumeRole"}]},"Policies":[{"PolicyName":"GatefoldAPIDDBPermission","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["dynamodb:GetItem","dynamodb:PutItem"],"Resource":{"Fn::GetAtt":["GatefoldDDBTable","Arn"]}}]}}],"RoleName":"GatefoldAPIDDBRole"}}}}